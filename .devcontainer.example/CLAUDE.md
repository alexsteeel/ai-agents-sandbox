# .devcontainer/CLAUDE.md

This directory contains the minimal devcontainer implementation template using the secure foundation.

## Purpose

Provides a ready-to-use template that projects can copy and customize while maintaining security controls.

## Quick Start

```bash
# Copy to your project
cp -r .devcontainer.example /path/to/your-project/.devcontainer

# Configure environment
cd /path/to/your-project/.devcontainer
cp .env.example .env
# Edit .env as needed

# Copy secure init template (optional)
cp secure.init.sh.template secure.init.sh
# Add your credentials to secure.init.sh

# Initialize (first time only)
./init-project.sh /path/to/your-project

# Open in IDE (VS Code or PyCharm)
```

### Using with DevContainer CLI
The devcontainer can also be started using the DevContainer CLI:
```bash
devcontainer up --workspace-folder .
```

**Note**: The `init-project.sh` script accepts the project directory as an argument, which is automatically passed by `devcontainer.json` during initialization.

## Configuration Files

### `.env` and `.user.env`
Environment configuration split into two files:

**`.env`** (auto-generated by `ai-sbx-init-project`):
```bash
# Project Configuration (auto-generated)
PROJECT_NAME=<directory_name>
PROJECT_DIR=<absolute_path>
COMPOSE_PROJECT_NAME=<directory_name>
```

**`.user.env`** (optional, user preferences):
```bash
# User preferences (gitignored)
# Preferred IDE for task worktrees
PREFERRED_IDE=pycharm

# Simplified upstream proxy configuration
UPSTREAM_PROXY=socks5://host.gateway:8900
# or
UPSTREAM_PROXY=http://proxy.example.com:3128

# Domains that bypass upstream proxy
NO_UPSTREAM=github.com,gitlab.com,bitbucket.org

# Additional whitelisted domains
USER_WHITELIST_DOMAINS=api.myproject.com,cdn.myproject.com
```

### `devcontainer.json`
VS Code/PyCharm configuration that:
- References compose files in order
- Sets up initialization and post-create commands
- Configures environment variables
- Manages container lifecycle

### `local.project.yaml`
Empty by default, used for project-specific services:
```yaml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: dev
    networks:
      - claude-internal
```

### `override.user.yaml`
User customizations that override base settings:
- Additional whitelisted domains
- Custom Docker image builds
- Environment variables
- Resource limits

### `secure.init.sh` (optional)
Script for sensitive configuration:
- API keys and tokens
- Git credentials
- SSH keys
- Registry logins

**Important**: 
- Copy from `secure.init.sh.template`
- Never commit this file (it's in .gitignore)
- Automatically copied to new worktrees

## Docker Compose Structure

The devcontainer uses a layered compose configuration:
1. `local.project.yaml` - Project-specific services (empty by default)
2. `/usr/local/share/ai-agents-sandbox/docker-compose.base.yaml` - Base foundation
3. `override.user.yaml` - User customizations

This allows for:
- Clean separation of concerns
- Easy updates to base configuration
- Project-specific customization
- User preference persistence

## Extending the Template

### Adding Services
Edit `local.project.yaml`:
```yaml
services:
  redis:
    image: redis:7-alpine
    networks:
      - claude-internal
    volumes:
      - redis-data:/data

volumes:
  redis-data:
```

### Custom Docker Image
Edit `override.user.yaml`:
```yaml
services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
```

Create `Dockerfile`:
```dockerfile
FROM ai-agents-sandbox/devcontainer:latest
USER claude
# Add project-specific tools
RUN pip install --user poetry
```

### Additional Domains
Edit `override.user.yaml`:
```yaml
services:
  tinyproxy-devcontainer:
    environment:
      USER_WHITELIST_DOMAINS: api.example.com,cdn.example.com
```

## Security Notes

⚠️ **ALWAYS maintain**:
- Services on `claude-internal` network
- Non-root user (claude)
- Proxy-only internet access
- No sudo or root access
- No direct port exposure

✅ **Best practices**:
- Store secrets in `.env` or `secure.init.sh`
- Use read-only mounts for sensitive files
- Review all volume mounts
- Keep proxy whitelist minimal
- Use environment variables for configuration

## Troubleshooting

### Permission Issues
```bash
# Re-run initialization
./init-project.sh /path/to/project

# Or manually fix
sudo chgrp -R local-ai-team .
sudo chmod -R g+rw .
find . -type d -exec chmod g+s {} +
```

### Network Issues
```bash
# Test from container
docker exec devcontainer /home/claude/scripts/test-network.sh

# Check proxy logs
docker logs tinyproxy-devcontainer
```

### IDE Integration
**VS Code**: Should detect `.devcontainer` automatically
**PyCharm**: Settings → Python Interpreter → Docker Compose → devcontainer

## Files in This Template

- `devcontainer.json` - IDE configuration
- `local.project.yaml` - Project services (empty)
- `override.user.yaml` - User customizations
- `Dockerfile` - Example for extending base image
- `.env.example` - Environment template
- `.gitignore` - Ignore sensitive files
- `init-project.sh` - Initialization wrapper
- `secure.init.sh.template` - Sensitive config template
- `README.md` - User documentation
- `CLAUDE.md` - This file