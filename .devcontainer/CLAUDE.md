# .devcontainer/CLAUDE.md

This directory contains the minimal devcontainer implementation template using the secure foundation.

## Purpose

Provides a ready-to-use template that projects can copy and customize while maintaining security controls.

## Quick Start

```bash
# Copy to your project
cp -r .devcontainer /path/to/your-project/

# Configure environment
cd /path/to/your-project/.devcontainer
cp .env.example .env
# Edit .env as needed

# Initialize (first time only)
./init-project.sh /path/to/your-project

# Start services
docker compose up -d
```

## Configuration Files

### `.env`
Environment configuration (auto-generated by `ai-sbx-init-project`):
```bash
# Project Configuration (auto-generated)
PROJECT_NAME=<directory_name>
PROJECT_DIR=<absolute_path>
COMPOSE_PROJECT_NAME=<directory_name>
```

**Important**: 
- `.env` is auto-generated by `ai-sbx-init-project` script
- `PROJECT_NAME` and `COMPOSE_PROJECT_NAME` use directory basename
- This ensures unique Docker volume and container names per project
- `.env` is gitignored (contains local paths)
- Additional proxy settings can be configured in `override.yaml`

### `docker-compose.yaml`
Orchestrates three services:

1. **tinyproxy**: Filtering proxy gateway
   - Network: claude-external (bridge)
   - Port: 8888
   - Image: ai-agents-sandbox/tinyproxy:latest

2. **devcontainer**: Development environment
   - Network: claude-internal (internal)
   - User: claude (non-root)
   - Proxy: All traffic via tinyproxy-devcontainer
   - Image: ai-agents-sandbox/devcontainer:latest or custom
   - Notification support via mounted volume

3. **docker**: Docker daemon (Docker-in-Docker)
   - Network: claude-internal (internal)
   - Privileged: Required for Docker-in-Docker
   - Certificates: TLS certificates for docker-registry-proxy
   - Uses docker-registry-proxy for all image pulls

### `devcontainer.json`
VS Code configuration:
- Service: Points to docker-compose service
- Features: Additional VS Code features
- Settings: Editor and terminal configuration
- Extensions: Recommended extensions
- Mounts: Source code and Docker socket

### Whitelist Configuration
Project-specific allowed domains are configured in `override.yaml`:

```yaml
services:
  tinyproxy-devcontainer:
    environment:
      USER_WHITELIST_DOMAINS: gitlab.com,youtrack.com,api.myproject.com
```

These domains are merged with built-in defaults at runtime. The entrypoint script generates two patterns per domain to match both the exact domain and its subdomains.

**Note**: Docker registry access is handled transparently by docker-registry-proxy. To add custom registries, edit `host/docker-proxy/.env`.

### `override.yaml`
Project-specific Docker Compose overrides:
- Customizes service configurations
- Adds additional services (databases, caches)
- Sets environment variables
- Mounts additional volumes

**Path considerations**:
- Docker Compose doesn't support VS Code variables (`${localWorkspaceFolder}`)
- **Important**: Relative paths won't work because the base compose file is in `/usr/local/share/ai-agents-sandbox`
- **Use environment variables**: `context: ${PROJECT_DIR}/.devcontainer` (PROJECT_DIR is set in .env)
- This ensures the build context is correctly resolved regardless of where Docker Compose runs from

### `initialize.sh`
One-time setup script that performs critical host setup:

1. **Creates local-ai-team group** (GID 3000) on host for file sharing
2. **Sets directory permissions** so container's claude user can write
3. **Starts Docker services** with project-specific namespace
4. **Copies Docker certificates** from docker-in-docker container
5. **Creates notification directory** `$HOME/.claude-notifications` with proper permissions

Run once per project:
```bash
./init-project.sh /absolute/path/to/project
```

This script MUST be run before starting the devcontainer to ensure proper permissions.

### `Dockerfile` (optional)
Extend base image for project needs:
```dockerfile
FROM ai-agents-sandbox/devcontainer:latest

# Add project-specific tools (as non-root user)
USER claude
RUN pip install --user project-dependencies

# Maintain security - no sudo, no root
WORKDIR /workspace
```

## Network Architecture

```
Internet
    ↕
[tinyproxy-devcontainer] - claude-external network (bridge)
    ↕ (proxy only)
[devcontainer] - claude-internal network (internal: true)
    ↕ (local only)
[docker] - claude-internal network (internal: true)
    ↓
[docker-registry-proxy] - Transparent image caching
```

**Simplified Security Model**:
- Internal network blocks direct internet access
- Devcontainer uses tinyproxy for general internet
- Docker uses docker-registry-proxy for images only
- No container can bypass isolation

## IDE Integration

### VS Code
1. Open project folder
2. VS Code detects `.devcontainer/devcontainer.json`
3. Prompts to "Reopen in Container"
4. Automatically configures environment

### PyCharm
1. Configure Docker as Python interpreter
2. Use docker-compose service: `devcontainer`
3. Python path: `/usr/local/bin/python`
4. Working directory: `/workspace`

### Claude Code
```bash
# From devcontainer
claude --dangerously-skip-permissions

# Or from host (if Claude CLI installed)
docker exec -it devcontainer claude --dangerously-skip-permissions
```

## Customization

### Adding Tools
Edit `Dockerfile` to add project-specific tools:
```dockerfile
# Always as non-root user
USER claude
RUN npm install -g project-tool
```

### Adding Whitelisted Domains
Edit `whitelist.txt`:
```
newdomain.com
api.newservice.com
```

Then restart proxy:
```bash
docker compose restart tinyproxy
```

### Environment Variables
Add to `.env`:
```bash
MY_API_KEY=secret
DATABASE_URL=postgresql://...
```

Access in container:
```bash
docker exec devcontainer env | grep MY_
```

## Validation

### Test Network Isolation
```bash
# Should fail (no direct internet)
docker exec devcontainer sh -c 'unset http_proxy https_proxy && curl google.com'

# Should work (via proxy, if whitelisted)
docker exec devcontainer curl https://github.com
```

### Check User Permissions
```bash
# Should show 'claude' user, no sudo
docker exec devcontainer whoami
docker exec devcontainer sudo ls  # Should fail
```

### Verify Proxy Configuration
```bash
# Check environment
docker exec devcontainer env | grep -i proxy

# Test proxy filtering
docker exec devcontainer curl https://whitelisted.com  # OK
docker exec devcontainer curl https://blocked.com      # Denied
```

## Troubleshooting

### Container Won't Start
- Check Docker daemon: `docker ps`
- Verify networks: `docker network ls | grep claude`
- Check logs: `docker compose logs`

### Can't Access External Sites
- Add to `whitelist.txt`
- Restart proxy: `docker compose restart tinyproxy`
- Check proxy logs: `docker logs tinyproxy`

### IDE Can't Connect
- Ensure container running: `docker ps`
- Check service name matches
- Verify Docker socket mounted

### Permission Errors
- Never use sudo in containers
- Check file ownership: should be claude:local-ai-team
- Use `chown claude:local-ai-team` if needed

## Security Checklist

✅ **Required**:
- [ ] Network internal: `internal: true`
- [ ] User non-root: `claude` (UID 1001)
- [ ] Proxy configured: Port 8888
- [ ] Filter enabled: `FilterDefaultDeny Yes`
- [ ] No sudo access: Commands fail
- [ ] No SSH server: Not installed
- [ ] No passwords: No authentication

❌ **Never**:
- [ ] Change network to external
- [ ] Add sudo or root access
- [ ] Disable proxy filtering
- [ ] Expose container ports
- [ ] Add authentication
- [ ] Install SSH servers

Remember: Security model depends on proper configuration. When extending, maintain all security constraints.

## Notification System Integration

The devcontainer supports host notifications through a shared volume:

### Setup
1. **Host directory**: `$HOME/.claude-notifications` created by `initialize.sh`
2. **Container mount**: Maps to `/workspace/.notifications` 
3. **Hook location**: `/home/claude/claude-defaults/hooks/notify.sh`

### Host Watcher
Run on host for desktop notifications:
```bash
./host-scripts/notify-watch.sh
```

### Testing from Container
```bash
/home/claude/claude-defaults/hooks/notify.sh "test" "Message here"
```

See `host-scripts/CLAUDE.md` for detailed host-side setup.