#!/bin/bash

# Fast host-side notification watcher using inotify for Claude Code
# Watches for notification files and displays desktop notifications instantly

WATCH_DIR="$HOME/.claude/notifications"
NOTIFY_FILE="$WATCH_DIR/notify.txt"

# Ensure directory exists
mkdir -p "$WATCH_DIR"

echo "Claude notification watcher (fast mode) started"
echo "Watching: $WATCH_DIR"
echo "Press Ctrl+C to stop"

# Function to show notification
show_notification() {
    local title="$1"
    local message="$2"
    local urgency="${3:-normal}"
    
    # Use notify-send if available
    if command -v notify-send &> /dev/null; then
        notify-send -u "$urgency" -i dialog-information "$title" "$message"
    else
        echo "NOTIFICATION: $title - $message"
    fi
}

# Function to process notification
process_notification() {
    if [ -f "$NOTIFY_FILE" ]; then
        # Read notification
        content=$(cat "$NOTIFY_FILE" 2>/dev/null)
        
        if [ -n "$content" ]; then
            # Parse content
            project=$(echo "$content" | grep -oP '^\[.*\] \K[^$]+' | head -1)
            type=$(echo "$content" | grep "Type:" | cut -d: -f2- | xargs)
            message=$(echo "$content" | grep "Message:" | cut -d: -f2- | xargs)
            
            # Determine urgency based on type
            urgency="normal"
            case "$type" in
                clarification|blocked|error|approval)
                    urgency="critical"
                    ;;
                complete)
                    urgency="low"
                    ;;
            esac
            
            # Show notification
            title="Claude: $project"
            show_notification "$title" "$message" "$urgency"
        fi
        
        # Remove file after processing
        rm -f "$NOTIFY_FILE"
    fi
}

# Check if inotifywait is available for instant notifications
if command -v inotifywait &> /dev/null; then
    echo "Using inotify for instant notifications..."
    
    # Process any existing notification first
    process_notification
    
    # Watch for new files with inotify
    while true; do
        # Wait for file creation or modification in the directory
        inotifywait -q -e create -e modify "$WATCH_DIR" 2>/dev/null
        
        # Small delay to ensure file is fully written
        sleep 0.1
        
        # Process the notification
        process_notification
    done
else
    echo "inotifywait not found, falling back to polling mode..."
    echo "Install inotify-tools for instant notifications: sudo apt-get install inotify-tools"
    
    # Fallback to polling with shorter interval
    while true; do
        process_notification
        
        # Shorter delay for faster response
        sleep 0.2
    done
fi