Use an isolated, self-contained developer environment per task with all required services.
Each task lives in its own Git worktree for clean separation.

Inside the container, the user is non‑root with restricted permissions to reduce risk.

## Architecture

This repo provides a secure, proxy-enforced devcontainer environment with strict egress control and Docker network
isolation. Tinyproxy is the sole egress gateway; all containers reside on an internal network and must use the proxy.

Diagrams (from `docs/`):

### Containers
<p>
  <img src="docs/architecture.png" alt="Architecture" title="Architecture" width="800"/>
</p>
<em>Notes:</em>
<br/>- Tinyproxy is the sole egress gateway; default‑deny filter allows only listed domains.
<br/>- `claude-internal` network isolates devcontainer and docker‑dind from the Internet.
<br/>- `egress-proxy` attaches to the external network and serves HTTP(S) proxy on port 8888.

### Agents Team
<p>
  <img src="docs/agents_team.png" alt="Agents Team" title="Agents Team" width="400"/>
</p>
<em>Notes:</em>
<br/>- Claude Code coordinates tasks; hooks run post‑task to lint/validate.
<br/>- Common and Python checks are separated for clarity and extensibility.

### Teams Collaboration
<p>
  <img src="docs/teams_isolation.png" alt="Teams Collaboration" title="Teams Collaboration" width="400"/>
</p>
<em>Notes:</em>
<br/>- Workspaces/teams are isolated; no lateral container traffic across internal networks.
<br/>- All outbound access per workspace flows via the same controlled egress proxy.

### Egress proxy and allowlist

- Tinyproxy configuration and filter are generated by `.devcontainer/initialize.sh`.
- The allowlist is built by merging:
  - Default domains baked into the image: `/usr/local/etc/default-allowed-domains.txt`.
  - Project domains: `.devcontainer/allowed-domains.txt`.
- Default list covers common tooling (GitHub, raw GitHub, PyPI, files.pythonhosted.org, GitLab).
- Project file should contain only project-specific domains (see `.devcontainer/allowed-domains.txt`).

## Hooks: common and Python

- Common linters: `shellcheck`, `shfmt`, `hadolint`, `yamllint` via `.claude/hooks/lint_common.py`.
- Python linters: `ruff`, `black` via `.claude/hooks/lint_python.py` using `uvx` (on-demand, through proxy).
- Both run on `SubagentStop` as configured in `claude-defaults/settings.json` and log to:
  - `.claude/logs/linters_common.json`
  - `.claude/logs/linters_python.json`

## Why Python for hook scripts?

- Reliable subprocess handling and structured JSON logging without fragile shell pipelines.
- Clean summarization/aggregation across tools; easier error handling and future extensibility.
- `uv` is already installed in the base image, enabling isolated tool execution with caching and proxy support.
  Bash wrappers would still spawn external tools; Python gives simpler cross-platform behavior.

## Quick start

1) Copy the `.devcontainer/` folder from this repo into the root of your own project repository.
2) Build the base image once:
   
   ```bash
   devcontainer_dockerfile_base/build_image.sh
   ```
3) Open your project in a JetBrains IDE (PyCharm/Rider/GoLand) and accept the prompt to open in a Dev Container.
4) Optional: add project-specific domains to `.devcontainer/allowed-domains.txt` (defaults are baked into the image).